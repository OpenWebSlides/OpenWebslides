#!/usr/bin/env bash

APP_ROOT=/opt/openwebslides/OpenWebslides
BRANCH=${1:-master}

cd "${APP_ROOT}"

# Error handling
trap _error_handler ERR
function _error_handler() {
  echo -e "\e[1;31m== Command exited unsuccessfully ==\e[0m"
  exit 1
}

echo "== Retrieving sources =="
git fetch --all
REF=`git rev-parse origin/${BRANCH}`
git checkout "${REF}"

echo "== Building application image =="
docker build -t openwebslides/openwebslides:latest .

echo "== Deploying application =="
# Don't fail docker-compose down
docker-compose down || true
docker-compose up -d
