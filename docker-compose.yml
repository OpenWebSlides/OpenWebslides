version: '3'

services:
  ##
  # Application container
  #
  app:
    build: .
    env_file:
      - openwebslides.env
    environment:
      - RAILS_ENV=production
    volumes:
      - public:/app/public/
      - data:/app/data/
    restart: always
    depends_on:
      - postgres
      - sidekiq
      - redis
    links:
      - postgres
      - redis

  ##
  # Database container
  #
  postgres:
    image: postgres:9.6
    volumes:
      - postgres:/var/lib/postgresql/data/

  ##
  # Sidekiq container
  #
  sidekiq:
    build: .
    env_file:
      - openwebslides.env
    volumes:
      - /var/run/postgresql/:/var/run/postgresql/
    depends_on:
      - postgres
      - redis
    links:
      - redis
    restart: always
    command: bundle exec sidekiq

  ##
  # Redis container
  #
  redis:
    image: redis:3.0
    volumes:
      - redis:/var/lib/redis/data/
    restart: always

volumes:
  # Repository data volume
  data:

  # Public assets (frontend) volume
  public:

  # Database volume
  postgres:

  # Redis volume
  redis:
